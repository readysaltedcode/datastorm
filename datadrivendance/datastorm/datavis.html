<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- TODO: fill this in -->
    <meta name="description" content="datastorm: is a digital data driven dance performance that derives its movements and concepts from computer science theory. The performance will break down certain theories and concepts during the performance through the movement of ballet.">
    <meta name="keywords" content="d3, digital, ballet, DataVis, SVG">
    <meta name="author" content="readysaltedcode cic">


    <title>Data Vis</title>

    <!-- Core Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
    <!-- arrastre.org CSS -->
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <!-- Google font - Quicksand -->
    <link href='http://fonts.googleapis.com/css?family=Quicksand:700' rel='stylesheet' type='text/css'>

    <!-- Favicon -->
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

  </head>

  <body>
    <div class="container">
      <nav class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html"><img src="img/logo.png" /></a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav" id="nav-list">
              <li><a href="about.html">ABOUT</a></li>
              <li><a href="dance.html">DANCE</a></li>
              <li><a href="datavis.html">DATA VIS</a></li>
              <li><a href="resources.html">RESOURCES</a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
      </nav>
      <div class="row main-container">
        <div class="col-md-12">
          <div id='datavis'>
            <div class="loading">
              <button class="btn btn-lg btn-default"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span> Loading visualisation</button>
            </div>
            <div id='animation-container-1'>
            <div class="row data-vis-header">
              <div class="col-md-1">
              </div> <!-- /col -->
              <div class="col-md-10" id="data-vis-nav">
                <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1 data-vis-nav-button">
                  <a href="datavis6.html"><span class="glyphicon glyphicon-chevron-left"></span></a>
                </div> <!-- /col -->
                <div class="col-lg-10 col-md-10 col-sm-10 col-xs-10">
                  <p class="data-vis-title">VIRUS</p>
                </div> <!-- /col -->
                <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1 data-vis-nav-button">
                  <a href="datavis2.html"><span class="glyphicon glyphicon-chevron-right"></span></a>
                </div> <!-- /col -->
              </div> <!-- /col -->
              <div class="col-md-1">
              </div> <!-- /col -->
            </div> <!-- /row -->
              <div class="row data-vis-container">
                <div class="col-md-1">
                </div> <!-- /col -->
                  <div class="col-md-10" id="data-vis-animation">

                    <div class="wrapper">
                      <canvas id="mycanvas"></canvas>
                    </div>

                    <script src="https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/virus/js/d3.min.js"></script>
                    <script src="https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/virus/js/lodash.min.js"></script>
                    <script src="https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/virus/js/requestanimframe.js"></script>
                    <script src="https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/virus/js/datastorm-canvas.js"></script>
                    <script src="js/virus.js"></script>

                  </div> <!-- /col -->
                <div class="col-md-1">
                </div> <!-- /col -->
              </div> <!-- /data-vis-container -->
            </div><!-- /animation-container-1 -->


            <div class="row data-vis-subnav">
              <div class="col-md-1 hidden-sm hidden-xs">
              </div> <!-- /col -->
              <div class="col-md-10" id="data-vis-subnav">

                <a href="datavis.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-1" id="active-data-vis-button">
                    <p>VIRUS</p>
                  </div>
                </a>

                <a href="datavis2.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-2">
                    <p>PROTOCOL</p>
                  </div>
                </a>

                <a href="datavis3.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-3">
                    <p>NETWORK</p>
                  </div>
                </a>

                <a href="datavis4.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-4">
                    <p>FORECAST</p>
                  </div>
                </a>

                <a href="datavis5.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-5">
                    <p>AUDIOSTORM</p>
                  </div>
                </a>

                <a href="datavis6.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-6">
                    <p>RAIN</p>
                  </div>
                </a>

              </div> <!-- /col -->
              <div class="col-md-1"></div>
            </div> <!-- /row -->


            <div id='code-container-1' class="row data-vis-code">
              <div class="col-md-1 hidden-sm hidden-xs">
              </div> <!-- /col -->
              <div class="col-md-10 javascript-container">
                <pre class="prettyprint">

&quot;use strict&quot;;
var datastorm = datastorm || {};

datastorm.virus = (function(){
  var my = {};

  var elements = {};

  var width, height;
  var active = true;

  var config = {};

  var nodes = [], links = [];

  var force = d3.layout.force()
    .charge(-800)
    .linkDistance(50)
    .linkStrength(function(d) {
      return d.strength;
    })
    .gravity(0.01)
    .friction(0.1);

  var timer;

  var ctx = datastorm.canvas.ctx;

  function init() {

    d3.select(&#39;canvas&#39;)
      .attr(&#39;width&#39;, config.width)
      .attr(&#39;height&#39;, config.height);

    force.size([config.width, config.height]);
  }




  function forceEnd() {
    // updatePositions();
    // updateNetwork();
  }

  function updateNetwork() {

    // Clone, otherwise adding nodes whilst iterating is not clever :)
    nodes = _.clone(datastorm.virus.sim.getUsers());
    links = _.clone(datastorm.virus.sim.getLinks());

    force.nodes(nodes)
      .links(links)
      .start();
  }

  function render() {
    ctx.globalAlpha = 1;

    ctx.fillStyle = &quot;rgba(0, 0, 0, 0.6)&quot;;
    ctx.fillRect(0, 0, config.width, config.height);



    ctx.globalAlpha = 0.5;

    // Links
    ctx.strokeStyle = &#39;rgba(200, 200, 255, 0.7)&#39;;
    ctx.lineWidth = 0.5;

    _.each(links, function(d) {
      datastorm.canvas.drawLine(d.source.x, d.source.y, d.target.x, d.target.y);
    });

    // // Nodes
    // console.log(&#39;render&#39;, nodes.length);
    ctx.fillStyle = &#39;rgba(200,200,255,1)&#39;;
    _.each(nodes, function(d) {
      // console.log(d);
      // ctx.fillStyle = colorScale(d.subject * 2);

      var activeMessages = _.filter(d.messages, function(dd) {
        return dd.active;
      });

      var fill = &#39;#ddd&#39;;

      var radius = 3;
      if(activeMessages.length &gt; 0) {
        fill = activeMessages[0].color;
        radius = 6;
      }

      ctx.fillStyle = fill;

      datastorm.canvas.drawCircle(d.x, d.y, radius);
    });
  }

  function showMessages() {
    elements.svg
      .select(&#39;.nodes&#39;)
      .selectAll(&#39;circle&#39;)
      .each(function(d) {
        var activeMessages = _.filter(d.messages, function(dd) {
          return dd.active;
        });

        var fill = &#39;#ddd&#39;;

        if(activeMessages.length &gt; 0)
          fill = activeMessages[0].color;

        d3.select(this)
          .style(&#39;fill&#39;, fill)
          .attr(&#39;r&#39;, activeMessages.length &gt; 0 ? 6 : 3);

      });
  }


  my.init = function(conf) {
    _.assign(config, conf);

    init();

  };

  my.start = function() {
    datastorm.virus.sim.start();
    setInterval(render, 100);
  }

  my.stop = function() {
    datastorm.virus.sim.stop();
  };

  my.networkUpdate = function() {
    updateNetwork();
  }

  return my;
}());

&quot;use strict&quot;;
var datastorm = datastorm || {};

datastorm.virus.sim = (function(){
  var my = {};

  var timer;
  var users = [], /*messages = [],*/ links = [];
  var messageId = -1;

  var config = {
    addUserProbability: 0.2,
    addMessageProbability: 0.6,
    addFriendProbability: 1,
    repeatMessageProbability: 0.9,
    repeatMessageTimespan: 2000, // timespan (milliseconds) in which a message can be repeated
    maxUsers: 120
  };


  /*-----
  HELPERS
  -----*/
  function shouldDo(probability) {
    // Decide, based on the given probability, whether event should occur
    return Math.random() &lt; probability;
  }

  function randomColor() {
    var color = d3.rgb(Math.random() * 255, Math.random() * 255, Math.random() * 255);
    color = color.toString();
    // console.log(color);
    return color;
  }

  /*----
  EVENTS
  ----*/
  function addUser() {
    if(!shouldDo(config.addUserProbability))
      return;

    if(users.length &gt; config.maxUsers)
      return;

    var newUser = {
      id: users.length,
      chatty: 0.01 + 0.02 * Math.random(), // how often user messages
      friendly: 0.8 + 0.2 * Math.random(), // how likely user is to friend another user
      interesting: Math.random(), // how interesting the user&#39;s messages are
      subject: Math.floor(Math.random() * 10), // the user&#39;s interest area,
      friends: [],
      messages: [],
      // isMessaging: false,
      // isRepeatedMessage: false,
      // messageTime: null,
      // isRepeatingMessage: false,
      x: 0.5 * config.width + 10 * Math.random(), //TODO
      y: 0.5 * config.height + 10 * Math.random()//TODO
    };

    // console.log(newUser);
    users.push(newUser);
    datastorm.virus.networkUpdate();
  }

  function purgeMessages() {
    var now = Date.now();
    // messages = _.filter(messages, function(message) {
    //   return now - message.time &lt; config.repeatMessageTimespan;
    // });

    _.each(users, function(user) {
      _.each(user.messages, function(m) {
        if(now - m.time &gt; config.repeatMessageTimespan)
          m.active = false;
      });
      // user.messages = _.filter(user.messages, function(m) {
      //   return now - m.time &lt; config.repeatMessageTimespan;
      // });
    });
  }

  function addMessage() {
    // Iterate through each user and make a message

    if(!shouldDo(config.addMessageProbability))
      return;

    _.each(users, function(user) {
      // console.log(user);

      // Throttle message creation (w/out changing globals)
      if(!shouldDo(0.05))
        return;

      if(!shouldDo(user.chatty))
        return;

      var now = Date.now();

      messageId++;

      var message = {
        id: messageId,
        originator: user.id,
        time: now,
        active: true,
        color: randomColor()
      };

      user.messages.push(message);
    });
  }

  function repeatMessage() {
    if(!shouldDo(config.repeatMessageProbability))
      return;

    var now = Date.now();

    _.each(users, function(user) {

      if(!shouldDo(4 * user.chatty))  // 4 times more likely to repeat a message?
        return;

      // console.log(&quot;looking at friends&quot;)

      // Go through each friend
      _.each(user.friends, function(friend) {

        // console.log(&#39;checking friend&#39;)

        if(!shouldDo(friend.interesting))
          return;

        // Go through each of friend&#39;s messages
        _.each(friend.messages, function(m) {

          if(!m.active)
            return;

          // console.log(&#39;checking messages&#39;)

          // check user hasn&#39;t already sent this one!
          var hasAlreadySent = false;
          _.each(user.messages, function(mm) {
            if(mm.id === m.id)
              hasAlreadySent = true;
          });
          if(hasAlreadySent)
            return;

          var reMessage = {
            id: m.id,
            originator: m.originator,
            time: now,
            color: m.color,
            active: true
          }
          user.messages.push(reMessage);

          // console.log(&#39;remessage!&#39;)
        });

      })
    });    
  }

  function addFriend() {
    if(!shouldDo(config.addFriendProbability))
      return;

    _.each(users, function(thisUser) {
      _.each(users, function(otherUser) {
        if(thisUser === otherUser)
          return;

        var probability = otherUser.chatty * thisUser.friendly * otherUser.interesting;

        // if(!shouldDo(otherUser.chatty))
        //   return;

        // if(!shouldDo(thisUser.friendly))
        //   return;

        // if(!shouldDo(otherUser.interesting))
        //   return;

        if(thisUser.subject !== otherUser.subject)
          probability *= 0.002;

        if(!shouldDo(probability))
          return;

        var alreadyFriends = _.find(thisUser.friends, function(friend) {
          return friend.id === otherUser.id;
        });
        if(alreadyFriends)
          return;

        // I don&#39;t think we have to do this reverse check...
        alreadyFriends = _.find(otherUser.friends, function(friend) {
          return friend.id === thisUser.id;
        });
        if(alreadyFriends)
          return;

        var strength = thisUser.subject === otherUser.subject ? 0.05 : 0.03;

        links.push({
          source: thisUser.id,
          target: otherUser.id,
          strength: strength
        });

        thisUser.friends.push(otherUser);
        otherUser.friends.push(thisUser);

        datastorm.virus.networkUpdate();


      });
    });
  }


  function update() {
    addUser();
    purgeMessages();
    addMessage();
    repeatMessage();
    addFriend();

    // console.log(users, messages, links);
  }

  my.init = function(conf) {
    _.assign(config, conf);
  };

  my.start = function() {
    timer = setInterval(update, 100);
  }

  my.stop = function() {
    clearInterval(timer);
  }

  my.getUsers = function() {
    return users;
  }

  my.getMessages = function() {
    return messages;
  }

  my.getLinks = function() {
    return links;
  }

  return my;
}());

(function(){

  var wrapper = d3.select(&#39;.wrapper&#39;);
  var width = wrapper.node().clientWidth;
  var height = wrapper.node().clientHeight;

  datastorm.virus.sim.init({
    width: width,
    height: height
  });
  datastorm.virus.init({
    width: width,
    height: height
  });

  datastorm.virus.start();

})();

                </pre>

                <p>See the Pen <a href='http://codepen.io/readysaltedcode/pen/MaaXwg/'>Datastorm - Virus</a> by Genevieve Smith-Nunes (<a href='http://codepen.io/readysaltedcode'>@readysaltedcode</a>) on <a href='http://codepen.io'>CodePen</a>.</p>

              </div> <!-- /col -->
              <div class="col-lg-2 col-md-1 hidden-sm hidden-xs">
              </div> <!-- /col -->
            </div> <!-- /row -->

          </div><!-- /datavis -->
        </div> <!-- /col -->
      </div> <!-- main-container -->

       <div class="row footer">
        <div class="col-lg-7 col-md-7 col-sm-7 col-xs-8 footer-left">
          <p>&copy; COPYRIGHT 2014 <a href="http://www.readysaltedcode.org/" class="footer-link">READYSALTEDCODE CIC</a></p>
        </div> <!-- /col -->
        <div class="col-lg-5 col-md-5 col-sm-5 col-xs-4 footer-right">
          <p><a href="termsandconditions.html" class="footer-link">TERMS &amp; CONDITIONS</a></p>
        </div> <!-- /col -->
      </div> <!-- /row -->
    </div> <!-- /container -->


    <!-- Scripts
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?lang=js&amp;skin=sunburst"></script>
  </body>
</html>
