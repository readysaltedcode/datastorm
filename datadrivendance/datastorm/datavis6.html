<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- TODO: fill this in -->
    <meta name="description" content="datastorm: is a digital data driven dance performance that derives its movements and concepts from computer science theory. The performance will break down certain theories and concepts during the performance through the movement of ballet.">
    <meta name="keywords" content="d3, digital, ballet, DataVis, SVG">
    <meta name="author" content="readysaltedcode cic">


    <title>Data Vis</title>

    <!-- Core Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
    <!-- arrastre.org CSS -->
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <!-- Google font - Quicksand -->
    <link href='http://fonts.googleapis.com/css?family=Quicksand:700' rel='stylesheet' type='text/css'>

    <!-- Favicon -->
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

  </head>

  <body>
    <div class="container">
      <nav class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html"><img src="img/logo.png" /></a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav" id="nav-list">
              <li><a href="about.html">ABOUT</a></li>
              <li><a href="dance.html">DANCE</a></li>
              <li><a href="datavis.html">DATA VIS</a></li>
              <li><a href="resources.html">RESOURCES</a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
      </nav>
      <div class="row main-container">
        <div class="col-md-12">
          <div id='datavis'>
            <div class="loading">
              <button class="btn btn-lg btn-default"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span> Loading visualisation</button>
            </div>
            <div id='animation-container-1'>
            <div class="row data-vis-header">
              <div class="col-md-1">
              </div> <!-- /col -->
              <div class="col-md-10" id="data-vis-nav">
                <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1 data-vis-nav-button">
                  <a href="datavis5.html"><span class="glyphicon glyphicon-chevron-left"></span></a>
                </div> <!-- /col -->
                <div class="col-lg-10 col-md-10 col-sm-10 col-xs-10">
                  <p class="data-vis-title">RAIN</p>
                </div> <!-- /col -->
                <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1 data-vis-nav-button">
                  <a href="datavis.html"><span class="glyphicon glyphicon-chevron-right"></span></a>
                </div> <!-- /col -->
              </div> <!-- /col -->
              <div class="col-md-1">
              </div> <!-- /col -->
            </div> <!-- /row -->
              <div class="row data-vis-container">
                <div class="col-md-1">
                </div> <!-- /col -->
                  <div class="col-md-10" id="data-vis-animation">
                    <div id="wrapper">
                      <canvas id="mycanvas" width="1200" height="800"></canvas>
                      <div id="info"></div>
                    </div>

                    <script src="https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/rain/js/lodash.min.js"></script><script src="https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/rain/js/d3.v3.min.js"></script>
                    <script src="https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/rain/js/requestanimframe.js"></script>
                    <script src="https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/rain/js/datastorm-canvas.js"></script>
                    <script src="js/rain.js"></script>

                  </div> <!-- /col -->
                <div class="col-md-1">
                </div> <!-- /col -->
              </div> <!-- /data-vis-container -->
            </div><!-- /animation-container-1 -->


            <div class="row data-vis-subnav">
              <div class="col-md-1 hidden-sm hidden-xs">
              </div> <!-- /col -->
              <div class="col-md-10" id="data-vis-subnav">

                <a href="datavis.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-1">
                    <p>VIRUS</p>
                  </div>
                </a>

                <a href="datavis2.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-2">
                    <p>PROTOCOL</p>
                  </div>
                </a>

                <a href="datavis3.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-3">
                    <p>NETWORK</p>
                  </div>
                </a>

                <a href="datavis4.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-4">
                    <p>FORECAST</p>
                  </div>
                </a>

                <a href="datavis5.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-5">
                    <p>AUDIOSTORM</p>
                  </div>
                </a>

                <a href="datavis6.html">
                  <div class="col-lg-five data-vis-subnav-button data-vis-subnav-6" id="active-data-vis-button">
                    <p>RAIN</p>
                  </div>
                </a>

              </div> <!-- /col -->
              <div class="col-lg-2 col-md-1"></div>
            </div> <!-- /row -->


            <div id='code-container-1' class="row data-vis-code">
              <div class="col-md-1 hidden-sm hidden-xs">
              </div> <!-- /col -->
              <div class="col-md-10 javascript-container">
                <pre class="prettyprint">

var datastorm = datastorm || {};

datastorm.rain = (function(){
  var my = {};
  
  var wrapper = d3.select('#wrapper');
  var width = wrapper.node().clientWidth;
  var height = wrapper.node().clientHeight;

  // var width = document.body.clientWidth;
  // var height = document.body.clientHeight;

  // var width = 1200, height = 800;

  var raindrops = [];
  var minMonthlyRainfall, maxMonthlyRainfall;
  var startTs; // start time of animation. Used to calculate elapsed time
  var previousTs;
  var tsStep; // time since the previous frame
  var durationTs = 400000; // full length of animation
  var animationActive = false;
  var doLabels = false;

  var nextActiveRaindropIndex = 0;

  var makeRaindropActiveInterval;

  // map radius to opacity
  var opacityScale = d3.scale.linear().domain([200, 0]).range([1, 0]).clamp(true);
  // var startTime = Date.now();

  var colour = d3.scale.linear().domain([-1, 5, 16, 22]).range([&#39;lightblue&#39;, &#39;white&#39;, &#39;orange&#39;, &#39;red&#39;]).clamp(true);

  // map the rainfall amount to how quickly the opacity reduces
  var circleOpacityDampingScale = d3.scale.linear();

  // map the rainfall amount to how quickly the radius reduces
  var circleStartOpacityScale = d3.scale.linear();

  var months = [&#39;Jan&#39;, &#39;Feb&#39;, &#39;Mar&#39;, &#39;Apr&#39;, &#39;May&#39;, &#39;Jun&#39;, &#39;Jul&#39;, &#39;Aug&#39;, &#39;Sep&#39;, &#39;Oct&#39;, &#39;Nov&#39;, &#39;Dec&#39;];

  var ctx = datastorm.canvas.ctx;


  function initialiseData(rainJson, tempJson) {
    // Create array of raindrops
    _.each(rainJson, function(year) {
      // console.log(year);
      _.each(year.rainfall, function(rainfall, i) {
        if(rainfall === -1)
          return;

        raindrops.push({
          rainfall: rainfall,
          radius: 1,
          active: false,
          labelDone: false,
          // opacity: 1,
          x: Math.random() * width,
          y: Math.random() * height,
          date: months[i] + &#39; &#39; + year.year
        });

      });
    });


    // Create array of temperature
    var temps = [];
    _.each(tempJson, function(year) {
      _.each(year.temp, function(t) {
        temps.push(t);
      });
    });

    // Merge in temperature
    _.each(raindrops, function(raindrop, i) {
      raindrop.temp = temps[i];
      raindrop.colour = colour(raindrop.temp);
    });

    minMonthlyRainfall = _.min(raindrops, function(d) {return d.rainfall;}).rainfall;
    maxMonthlyRainfall = _.max(raindrops, function(d) {return d.rainfall;}).rainfall;

    circleOpacityDampingScale.domain([minMonthlyRainfall, maxMonthlyRainfall]).range([1000, 8000]);
    circleStartOpacityScale.domain([minMonthlyRainfall, maxMonthlyRainfall]).range([0.3, 1]);

    _.each(raindrops, function(raindrop) {
      raindrop.opacityDamping = 6000; //circleOpacityDampingScale(raindrop.rainfall);

      raindrop.opacity = circleStartOpacityScale(raindrop.rainfall);
    });

    // console.log(raindrops);
  }


  function makeRaindropActive() {
    if(nextActiveRaindropIndex &gt;= raindrops.length)
      return;

    raindrops[nextActiveRaindropIndex].active = true;
    nextActiveRaindropIndex += 1;
  }

  function doFrame() {
    tsStep = Date.now() - previousTs;
    previousTs = Date.now();

    updateRaindropAttributes();

    ctx.globalAlpha = 1;
    ctx.fillStyle = &quot;rgba(0, 0, 0, 0.5)&quot;;
    ctx.fillRect(0, 0, width, height);

    render();

    var elapsedTs = Date.now() - startTs;
    if(elapsedTs &gt; durationTs)
      animationActive = false;

    if(animationActive)
      window.requestAnimationFrame(doFrame);
  }

  function updateRaindropAttributes() {
    _.each(raindrops, function(rd) {
      if(!rd.active)
        return;

      // Update radius
      rd.radius += tsStep / 20;  

      // Reduce opacity
      rd.opacity -= tsStep / rd.opacityDamping;
      if(rd.opacity &lt; 0) {
        rd.opacity = 0;
        rd.active = false;
      }
    });
  }

  function render() {
    // console.log(&#39;render&#39;);
    ctx.fillStyle = &#39;none&#39;;
    ctx.lineWidth = 4;


    _.each(raindrops, function(rd) {
      if(!rd.active)
        return;

      opacityScale.range([rd.opacity, 0]);

      for(var r = rd.radius; r &gt; 5; r -= 25) {
        ctx.strokeStyle = rd.colour;
        ctx.globalAlpha = opacityScale(r);
        datastorm.canvas.drawCircleOutline(rd.x, rd.y, r);
      }

      if(doLabels && rd.labelDone === false) {
        // console.log(&#39;label&#39;, rd.x, rd.y)
        ctx.fillStyle = rd.colour;
        ctx.font = &quot;14px sans-serif&quot;;
        ctx.globalAlpha = rd.opacity - 0.2;
        ctx.fillText(rd.date, rd.x - 30, rd.y + 5);
        // rd.labelDone = true;
        ctx.fillStyle = &#39;none&#39;;
      }
    });


  }

  my.init = function() {
    d3.json(&#39;https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/rain/data/rainfall.json&#39;, function(err, rainJson) {
      d3.json(&#39;https://d28qoto45d39ov.cloudfront.net/datastorm/visualisations/rain/data/maxtemp.json&#39;, function(err, tempJson) {
        initialiseData(rainJson, tempJson);
      });
    });
  };

  my.start = function() {
    animationActive = true;
    startTs = Date.now();

    makeRaindropActiveInterval = setInterval(makeRaindropActive, 500);
    window.requestAnimationFrame(doFrame);
  };

  my.stop = function() {
    animationActive = false;
    clearInterval(makeRaindropActiveInterval);
  }

  return my;
}());

datastorm.rain.init();
datastorm.rain.start();

                </pre>
                <p data-height="268" data-theme-id="0" data-slug-hash="EVVLQY" data-default-tab="result" data-user="readysaltedcode" class='codepen'>See the Pen <a href='http://codepen.io/readysaltedcode/pen/EVVLQY/'>Datastorm - Rain</a> by Genevieve Smith-Nunes (<a href='http://codepen.io/readysaltedcode'>@readysaltedcode</a>) on <a href='http://codepen.io'>CodePen</a>.</p>

              </div> <!-- /col -->
              <div class="col-md-1 hidden-sm hidden-xs">
              </div> <!-- /col -->
            </div> <!-- /row -->

          </div><!-- /datavis -->
        </div> <!-- /col -->
      </div> <!-- main-container -->


       <div class="row footer">
        <div class="col-lg-7 col-md-7 col-sm-7 col-xs-8 footer-left">
          <p>&copy; COPYRIGHT 2014 <a href="http://www.readysaltedcode.org/" class="footer-link">READYSALTEDCODE CIC</a></p>
        </div> <!-- /col -->
        <div class="col-lg-5 col-md-5 col-sm-5 col-xs-4 footer-right">
          <p><a href="termsandconditions.html" class="footer-link">TERMS &amp; CONDITIONS</a></p>
        </div> <!-- /col -->
      </div> <!-- /row -->
    </div> <!-- /container -->

    <!-- Scripts
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?lang=js&amp;skin=sunburst"></script>

  </body>
</html>
